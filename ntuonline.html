<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ntudioka Admin ¬∑ fixed upload</title>

    <!-- Firebase SDKs (compat version) -->
    <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-storage-compat.js"></script>

    <style>
        * { box-sizing: border-box; margin: 0; }
        body {
            background: #0e0f17;
            color: #f0f4ff;
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 2rem;
            max-width: 800px;
            margin: 0 auto;
        }
        h1 {
            font-weight: 500;
            font-size: 2.2rem;
            letter-spacing: -0.02em;
            margin-bottom: 2rem;
            border-left: 6px solid #00e5ff;
            padding-left: 1.3rem;
            background: linear-gradient(145deg, #ffffff20, transparent);
            border-radius: 0 20px 20px 0;
        }
        .card {
            background: #1a1e2f;
            padding: 1.7rem 1.9rem;
            border-radius: 28px;
            margin-bottom: 1.8rem;
            border: 1px solid #2e354a;
            box-shadow: 0 20px 30px -10px #00000060;
            backdrop-filter: blur(2px);
            transition: all 0.2s ease;
        }
        .card:hover { border-color: #00e5ff50; }
        .card h3 {
            margin-top: 0;
            margin-bottom: 1.4rem;
            font-weight: 500;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #cbd5ff;
        }
        input, input[type="file"] {
            width: 100%;
            padding: 14px 16px;
            margin-top: 8px;
            margin-bottom: 6px;
            border-radius: 18px;
            border: 1px solid #2f374e;
            background: #0d1224;
            color: white;
            font-size: 1rem;
            transition: 0.15s;
            outline: none;
        }
        input:focus { border-color: #00e5ff; box-shadow: 0 0 0 3px #00e5ff30; }
        input::placeholder { color: #6e7a9e; font-weight: 300; }
        button {
            padding: 12px 28px;
            margin-top: 18px;
            margin-right: 12px;
            border: none;
            border-radius: 40px;
            background: #00e5ff;
            color: #0a0e1c;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: 0 8px 16px -8px #00e5ff80;
            transition: all 0.15s;
            border: 1px solid #00e5ff;
        }
        button:hover {
            background: #7ef0ff;
            transform: scale(1.02);
            box-shadow: 0 12px 20px -8px #00e5ff;
        }
        button:active { transform: scale(0.98); }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .adminOnly { display: none; }
        .note {
            font-size: 0.9rem;
            margin-top: 8px;
            color: #97a9d6;
            border-left: 3px solid #00e5ff;
            padding-left: 12px;
            background: #03050b40;
            border-radius: 0 12px 12px 0;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #2d344b;
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
            display: none;
        }
        .progress-fill {
            height: 100%;
            background: #00e5ff;
            width: 0%;
            transition: width 0.3s;
        }
        hr { border: 0.5px solid #2d344b; margin: 1.8rem 0; }
        .status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 8px;
            font-size: 0.9rem;
        }
        .status.success { background: #00e5ff20; color: #00e5ff; }
        .status.error { background: #ff005520; color: #ff6b8b; }
    </style>
</head>
<body>

<h1>‚ö° Ntudioka ¬∑ admin core (fixed uploads)</h1>

<!-- LOGIN CARD -->
<div class="card adminOnly" id="loginCard" style="display:block">
    <h3>üîê Portal access</h3>
    <input id="email" placeholder="admin email" type="email" autocomplete="off">
    <input id="password" type="password" placeholder="password" autocomplete="off">
    <button onclick="login()">‚Üí Login</button>
    <div class="note">Use Firebase Auth + role in Firestore (roles/{uid} with field 'role':'admin')</div>
</div>

<!-- PODCAST SECTION -->
<div class="card adminOnly" style="display:none">
    <h3>üéô Upload podcast</h3>
    <input type="file" id="podFile" accept="audio/*">
    <input id="podTitle" placeholder="Episode title (required)">
    <div class="progress-bar" id="podcastProgress">
        <div class="progress-fill" id="podcastProgressFill"></div>
    </div>
    <button onclick="uploadPodcast()" id="podcastUploadBtn">üì§ Publish podcast</button>
    <div class="status" id="podcastStatus"></div>
    <div class="note">MP3, M4A ‚Äì stored in Firebase Storage / podcasts</div>
</div>

<!-- VIDEO POST SECTION -->
<div class="card adminOnly" style="display:none">
    <h3>üé• Upload video post</h3>
    <input type="file" id="videoFile" accept="video/*">
    <div class="progress-bar" id="videoProgress">
        <div class="progress-fill" id="videoProgressFill"></div>
    </div>
    <button onclick="uploadVideo()" id="videoUploadBtn">üì§ Upload & publish</button>
    <div class="status" id="videoStatus"></div>
    <div class="note">Video appears in 'posts' collection with admin flag</div>
</div>

<!-- LIVE STREAM SECTION -->
<div class="card adminOnly" style="display:none">
    <h3>üî¥ Publish live stream</h3>
    <input id="liveId" placeholder="YouTube video ID (e.g. dQw4w9WgXcQ)">
    <button onclick="setLive()">‚ñ∂Ô∏è Go live (set current)</button>
    <div class="status" id="liveStatus"></div>
    <div class="note">Overwrites live/current document</div>
</div>

<!-- small reminder -->
<hr style="opacity:0.2">
<div style="color:#5e6c96; text-align:center; font-size:0.85rem;">üîí admin functions appear after verification</div>

<script>
(function() {
    // ------ Firebase init ------
    const firebaseConfig = {
        apiKey: "AIzaSyDA02mVmQxC_cu2QCyq4NN8LhQIWo50V5A",
        authDomain: "ntudioka-online-c29d8.firebaseapp.com",
        projectId: "ntudioka-online-c29d8",
        storageBucket: "ntudioka-online-c29d8.appspot.com",
        messagingSenderId: "1015621578149",
        appId: "1:1015621578149:web:c755b458e505fd32928c4c"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const storage = firebase.storage();

    // Global flag
    let adminConfirmed = false;

    // DOM elements
    const loginCard = document.getElementById('loginCard');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const podFile = document.getElementById('podFile');
    const podTitle = document.getElementById('podTitle');
    const videoFile = document.getElementById('videoFile');
    const liveId = document.getElementById('liveId');
    
    // Progress elements
    const podcastProgress = document.getElementById('podcastProgress');
    const podcastProgressFill = document.getElementById('podcastProgressFill');
    const podcastStatus = document.getElementById('podcastStatus');
    const podcastBtn = document.getElementById('podcastUploadBtn');
    
    const videoProgress = document.getElementById('videoProgress');
    const videoProgressFill = document.getElementById('videoProgressFill');
    const videoStatus = document.getElementById('videoStatus');
    const videoBtn = document.getElementById('videoUploadBtn');
    
    const liveStatus = document.getElementById('liveStatus');

    const adminElements = document.querySelectorAll('.adminOnly');

    // Helper to show status
    function showStatus(element, message, type) {
        element.textContent = message;
        element.className = 'status ' + type;
        setTimeout(() => {
            element.textContent = '';
            element.className = 'status';
        }, 5000);
    }

    // Unlock dashboard
    function unlockDashboard() {
        if (loginCard) loginCard.style.display = 'none';
        adminElements.forEach(el => {
            if (el !== loginCard) {
                el.style.display = 'block';
            }
        });
        adminConfirmed = true;
        console.log('‚úÖ Dashboard unlocked');
    }

    // LOGIN function
    window.login = function() {
        const email = emailInput.value.trim();
        const password = passwordInput.value;
        if (!email || !password) {
            alert('Please enter email and password');
            return;
        }

        auth.signInWithEmailAndPassword(email, password)
            .then(() => {
                alert("Login successful. Verifying admin role...");
                passwordInput.value = '';
            })
            .catch(err => {
                alert('Login error: ' + err.message);
            });
    };

    // AUTH STATE WATCHER
    auth.onAuthStateChanged(async user => {
        if (!user) {
            adminConfirmed = false;
            adminElements.forEach(el => {
                if (el === loginCard) el.style.display = 'block';
                else el.style.display = 'none';
            });
            return;
        }

        console.log('User UID:', user.uid);

        try {
            const roleRef = db.collection('roles').doc(user.uid);
            const roleSnap = await roleRef.get();

            if (!roleSnap.exists) {
                alert("No role document found for this user.\nCreate document 'roles/" + user.uid + "' with field 'role': 'admin'");
                adminConfirmed = false;
                adminElements.forEach(el => el.style.display = 'none');
                return;
            }

            const roleData = roleSnap.data();
            if (roleData.role !== 'admin') {
                alert("Access denied. Your role is: " + roleData.role);
                adminConfirmed = false;
                adminElements.forEach(el => el.style.display = 'none');
                return;
            }

            // ADMIN VERIFIED
            adminConfirmed = true;
            alert('‚úÖ Admin confirmed ‚Äì dashboard unlocked');
            unlockDashboard();

        } catch (error) {
            console.error('Role check error:', error);
            alert('Error during role verification: ' + error.message);
            adminConfirmed = false;
            adminElements.forEach(el => el.style.display = 'none');
        }
    });

    // ----- UPLOAD PODCAST (FIXED) -----
    window.uploadPodcast = async function() {
        if (!adminConfirmed) {
            alert('Admin session required');
            return;
        }

        const file = podFile.files[0];
        const title = podTitle.value.trim();

        if (!file) {
            showStatus(podcastStatus, '‚ùå Select an audio file', 'error');
            return;
        }
        if (!title) {
            showStatus(podcastStatus, '‚ùå Podcast title is required', 'error');
            return;
        }

        // Disable button and show progress
        podcastBtn.disabled = true;
        podcastProgress.style.display = 'block';
        podcastProgressFill.style.width = '0%';
        showStatus(podcastStatus, '‚è´ Uploading podcast...', 'status');

        try {
            // Create unique filename with safe characters
            const timestamp = Date.now();
            const safeFileName = file.name.replace(/[^a-zA-Z0-9.]/g, '_');
            const fileName = `podcasts/${timestamp}_${safeFileName}`;
            
            // Create storage reference
            const storageRef = storage.ref().child(fileName);
            
            // Upload with progress tracking
            const uploadTask = storageRef.put(file);
            
            // Track progress
            uploadTask.on('state_changed', 
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    podcastProgressFill.style.width = progress + '%';
                },
                (error) => {
                    // Upload error
                    console.error('Upload error:', error);
                    podcastBtn.disabled = false;
                    podcastProgress.style.display = 'none';
                    showStatus(podcastStatus, '‚ùå Upload failed: ' + error.message, 'error');
                },
                async () => {
                    // Upload complete
                    try {
                        // Get download URL
                        const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                        
                        // Save to Firestore
                        await db.collection('podcasts').add({
                            title: title,
                            audioUrl: downloadURL,
                            created: firebase.firestore.FieldValue.serverTimestamp(),
                            uploadedBy: auth.currentUser ? auth.currentUser.uid : null,
                            fileName: file.name,
                            fileSize: file.size
                        });

                        // Reset UI
                        podcastBtn.disabled = false;
                        podcastProgress.style.display = 'none';
                        podcastFile.value = '';
                        podTitle.value = '';
                        
                        showStatus(podcastStatus, '‚úÖ Podcast published successfully!', 'success');
                    } catch (err) {
                        podcastBtn.disabled = false;
                        podcastProgress.style.display = 'none';
                        showStatus(podcastStatus, '‚ùå Firestore error: ' + err.message, 'error');
                    }
                }
            );
        } catch (err) {
            console.error('Setup error:', err);
            podcastBtn.disabled = false;
            podcastProgress.style.display = 'none';
            showStatus(podcastStatus, '‚ùå Error: ' + err.message, 'error');
        }
    };

    // ----- UPLOAD VIDEO (FIXED) -----
    window.uploadVideo = async function() {
        if (!adminConfirmed) {
            alert('Admin session required');
            return;
        }

        const file = videoFile.files[0];
        if (!file) {
            showStatus(videoStatus, '‚ùå Select a video file', 'error');
            return;
        }

        // Check file size (warn if > 100MB)
        if (file.size > 100 * 1024 * 1024) {
            if (!confirm('File is large (' + (file.size/1024/1024).toFixed(1) + 'MB). Continue?')) {
                return;
            }
        }

        videoBtn.disabled = true;
        videoProgress.style.display = 'block';
        videoProgressFill.style.width = '0%';
        showStatus(videoStatus, '‚è´ Uploading video...', 'status');

        try {
            const timestamp = Date.now();
            const safeFileName = file.name.replace(/[^a-zA-Z0-9.]/g, '_');
            const fileName = `videos/${timestamp}_${safeFileName}`;
            
            const storageRef = storage.ref().child(fileName);
            const uploadTask = storageRef.put(file);
            
            uploadTask.on('state_changed',
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    videoProgressFill.style.width = progress + '%';
                },
                (error) => {
                    console.error('Upload error:', error);
                    videoBtn.disabled = false;
                    videoProgress.style.display = 'none';
                    showStatus(videoStatus, '‚ùå Upload failed: ' + error.message, 'error');
                },
                async () => {
                    try {
                        const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                        
                        await db.collection('posts').add({
                            video: downloadURL,
                            admin: true,
                            time: firebase.firestore.FieldValue.serverTimestamp(),
                            type: 'video',
                            fileName: file.name,
                            fileSize: file.size,
                            uploadedBy: auth.currentUser ? auth.currentUser.uid : null
                        });

                        videoBtn.disabled = false;
                        videoProgress.style.display = 'none';
                        videoFile.value = '';
                        
                        showStatus(videoStatus, '‚úÖ Video uploaded and post created!', 'success');
                    } catch (err) {
                        videoBtn.disabled = false;
                        videoProgress.style.display = 'none';
                        showStatus(videoStatus, '‚ùå Firestore error: ' + err.message, 'error');
                    }
                }
            );
        } catch (err) {
            console.error('Setup error:', err);
            videoBtn.disabled = false;
            videoProgress.style.display = 'none';
            showStatus(videoStatus, '‚ùå Error: ' + err.message, 'error');
        }
    };

    // ----- SET LIVE STREAM -----
    window.setLive = async function() {
        if (!adminConfirmed) {
            alert('Admin session required');
            return;
        }

        const videoId = liveId.value.trim();
        if (!videoId) {
            showStatus(liveStatus, '‚ùå Enter a YouTube video ID', 'error');
            return;
        }

        liveStatus.textContent = '‚è´ Setting live stream...';
        liveStatus.className = 'status status';

        try {
            await db.collection('live').doc('current').set({
                videoId: videoId,
                time: firebase.firestore.FieldValue.serverTimestamp(),
                updatedBy: auth.currentUser ? auth.currentUser.uid : null
            });
            
            liveId.value = '';
            showStatus(liveStatus, '‚úÖ Live stream ID updated to: ' + videoId, 'success');
        } catch (err) {
            showStatus(liveStatus, '‚ùå Failed: ' + err.message, 'error');
        }
    };

    // Fix for variable name conflict
    const podcastFile = document.getElementById('podFile');
})();
</script>

<!-- roles reminder -->
<div style="background:#131725; border-radius:20px; padding:16px; margin-top:30px; border:1px dashed #3a435e; color:#a3b3e0">
    <span style="color:#00e5ff;">‚öôÔ∏è Firestore roles required:</span> collection <code style="background:#010313; padding:2px 8px; border-radius:40px;">roles</code> ‚Üí document <code style="background:#010313; padding:2px 8px; border-radius:40px;">{UID}</code> ‚Üí field <code style="background:#010313; padding:2px 8px; border-radius:40px;">role: "admin"</code>
</div>
</body>
</html>
