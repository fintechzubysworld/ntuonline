<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Ntudioka Admin</title>

<script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-storage-compat.js"></script>

<style>
body{background:#0e0f17;color:white;font-family:sans-serif;padding:25px}
.card{background:#1a1e2f;padding:20px;border-radius:15px;margin-bottom:20px}
input{width:100%;padding:10px;margin-top:8px;border-radius:10px}
button{padding:10px 18px;margin-top:10px;border:none;border-radius:15px;background:#00e5ff}
</style>
</head>

<body>

<h1>âš¡ Ntudioka Admin Dashboard</h1>

<div class="card adminOnly" style="display:none">
<h3>Login</h3>
<input id="email" placeholder="Email">
<input id="password" type="password" placeholder="Password">
<button onclick="login()">Login</button>
</div>

<div class="card adminOnly" style="display:none">
<h3>ðŸŽ™ Upload Podcast</h3>
<input type="file" id="podFile" accept="audio/*">
<input id="podTitle" placeholder="Podcast title">
<button onclick="uploadPodcast()">Upload</button>
</div>

<div class="card adminOnly" style="display:none">
<h3>ðŸŽ¥ Upload Video Post</h3>
<input type="file" id="videoFile" accept="video/*">
<button onclick="uploadVideo()">Upload Video</button>
</div>

<div class="card adminOnly" style="display:none">
<h3>ðŸ”´ Publish Live Stream</h3>
<input id="liveId" placeholder="YouTube Video ID">
<button onclick="setLive()">Go Live</button>
</div>

<script>
const firebaseConfig={
 apiKey:"AIzaSyDA02mVmQxC_cu2QCyq4NN8LhQIWo50V5A",
 authDomain:"ntudioka-online-c29d8.firebaseapp.com",
 projectId:"ntudioka-online-c29d8",
 storageBucket:"ntudioka-online-c29d8.appspot.com",
 messagingSenderId:"1015621578149",
 appId:"1:1015621578149:web:c755b458e505fd32928c4c"
};

firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();
const auth=firebase.auth();
const storage=firebase.storage();

let adminConfirmed=false;

//////////////// LOGIN //////////////////

function login(){
  const e=email.value;
  const p=password.value;

  auth.signInWithEmailAndPassword(e,p)
  .then(()=>{
    alert("Login successful. Checking admin role...");
  })
  .catch(err=>alert(err.message));
}

//////////////// AUTH STATE WATCHER //////////////////

auth.onAuthStateChanged(async user=>{
  if(!user) return;

  console.log("Logged in UID:",user.uid);

  try{
    const roleDoc=await db.collection("roles").doc(user.uid).get();

    if(!roleDoc.exists){
      alert("Logged in, but NO ROLE document found.\nCreate one in Firestore.");
      return;
    }

    if(roleDoc.data().role!=="admin"){
      alert("Logged in but NOT ADMIN");
      return;
    }

    adminConfirmed=true;
    alert("âœ… ADMIN VERIFIED â€” Dashboard unlocked");

    unlockDashboard();

  }catch(e){
    alert("Role check error: "+e.message);
  }
});

//////////////// UNLOCK DASHBOARD //////////////////

function unlockDashboard(){
  document.querySelectorAll(".adminOnly")
    .forEach(el=>el.style.display="block");
}

//////////////// PODCAST //////////////////

async function uploadPodcast(){
 if(!adminConfirmed) return alert("Admin login required");

 const file=podFile.files[0];
 const title=podTitle.value;
 if(!file||!title)return alert("Complete fields");

 const ref=storage.ref("podcasts/"+Date.now()+"_"+file.name);
 await ref.put(file);
 const url=await ref.getDownloadURL();

 await db.collection("podcasts").add({
   title,
   audioUrl:url,
   created:Date.now()
 });

 alert("Podcast uploaded successfully");
}

//////////////// VIDEO //////////////////

async function uploadVideo(){
 if(!adminConfirmed) return alert("Admin login required");

 const file=videoFile.files[0];
 if(!file)return alert("Select file");

 const ref=storage.ref("videos/"+Date.now()+"_"+file.name);
 await ref.put(file);
 const url=await ref.getDownloadURL();

 await db.collection("posts").add({
   video:url,
   admin:true,
   time:Date.now()
 });

 alert("Video uploaded successfully");
}

//////////////// LIVE //////////////////

async function setLive(){
 if(!adminConfirmed) return alert("Admin login required");

 await db.collection("live").doc("current").set({
   videoId:liveId.value,
   time:Date.now()
 });

 alert("Live stream published");
}
</script>
</body>
</html>


