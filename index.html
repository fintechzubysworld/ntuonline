<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Ntudioka Community</title>

<script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore-compat.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
body{
margin:0;
font-family:Arial;
background:linear-gradient(135deg,#0f172a,#1e293b);
color:white;
}

header{
background:#0ea5e9;
padding:15px;
display:flex;
justify-content:space-between;
align-items:center;
}

button{
padding:6px 12px;
border:none;
border-radius:20px;
background:#f97316;
color:white;
cursor:pointer;
}

button:hover{opacity:0.9;}

.section{
padding:20px;
}

.card{
background:#1e293b;
padding:15px;
border-radius:15px;
margin-bottom:15px;
}

input,textarea{
width:100%;
padding:8px;
margin-top:6px;
border-radius:8px;
border:none;
}

.chatBox{
height:250px;
overflow-y:auto;
background:#111827;
padding:10px;
border-radius:10px;
margin-bottom:10px;
}

.online{
color:#22c55e;
font-size:12px;
}
</style>
</head>

<body>

<header>
<h2><i class="fa-solid fa-globe"></i> Ntudioka Community</h2>

<div id="navArea">
<button onclick="showLogin()">Login</button>
<button onclick="showRegister()">Register</button>
</div>

</header>

<div class="section">

<!-- LIVE STREAM -->
<div class="card">
<h3>ğŸ”´ Live Stream</h3>
<div id="liveArea">Loading...</div>
</div>

<!-- EVENTS -->
<div class="card">
<h3>ğŸ“… Events</h3>
<div id="eventArea"></div>
</div>

<!-- FEED -->
<div class="card">
<h3>ğŸ“° Community Feed</h3>

<textarea id="feedInput" placeholder="Share something..."></textarea>
<button onclick="postFeed()">Post</button>

<div id="feedArea"></div>
</div>

<!-- GLOBAL CHAT -->
<div class="card">
<h3>ğŸ’¬ Community Chat</h3>

<div class="chatBox" id="chatMessages"></div>
<input id="chatInput" placeholder="Type message">
<button onclick="sendChat()">Send</button>
</div>

<!-- PRIVATE CHAT -->
<div class="card">
<h3>ğŸ“© Private Messages</h3>
<input id="privateEmail" placeholder="Enter user email">
<div class="chatBox" id="privateMessages"></div>
<input id="privateInput" placeholder="Type private message">
<button onclick="sendPrivate()">Send</button>
</div>

</div>

<!-- AUTH MODAL -->
<div id="authBox" style="display:none;padding:20px;">
<h3 id="authTitle"></h3>
<input id="email" placeholder="Email">
<input id="password" type="password" placeholder="Password">
<button onclick="submitAuth()">Submit</button>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDA02mVmQxC_cu2QCyq4NN8LhQIWo50V5A",
    authDomain: "ntudioka-online-c29d8.firebaseapp.com",
    projectId: "ntudioka-online-c29d8",
    storageBucket: "ntudioka-online-c29d8.firebasestorage.app",
    messagingSenderId: "1015621578149",
    appId: "1:1015621578149:web:c755b458e505fd32928c4c",
    measurementId: "G-JPVKYQRKEB"
  };
firebase.initializeApp(firebaseConfig);

/* ========= AUTH FIXED MODULE ========= */

const auth = firebase.auth();
const db = firebase.firestore();
  
/* ===============================
   USER PRESENCE SYSTEM
   =============================== */

const usersCollection = db.collection("users");

/* Mark User Online */
function setUserOnline(user){
    if(!user) return;

    usersCollection.doc(user.uid).set({
        email: user.email,
        online: true,
        lastSeen: null,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: true });
}

/* Mark User Offline */
function setUserOffline(user){
    if(!user) return;

    usersCollection.doc(user.uid).set({
        online: false,
        lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: true });
}

/* Auth State Listener */
auth.onAuthStateChanged(user=>{
    if(user){
        setUserOnline(user);
    }
});

/* Logout Override */
function logout(){
    const user = auth.currentUser;

    if(user){
        setUserOffline(user);
    }

    auth.signOut();
}

/* Detect Tab / Browser Close */
window.addEventListener("beforeunload", function () {
    const user = auth.currentUser;
    if(user){
        setUserOffline(user);
    }
});

/* Optional: Detect Page Visibility Change (Tab Switch) */
document.addEventListener("visibilitychange", function(){
    const user = auth.currentUser;
    if(!user) return;

    if(document.visibilityState === "hidden"){
        setUserOffline(user);
    } else {
        setUserOnline(user);
    }
});

let currentUser = null;
let authMode = "login";

/* Cache Elements */
const navArea = document.getElementById("navArea");
const authBox = document.getElementById("authBox");
const authTitle = document.getElementById("authTitle");
const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");

/* Show Login */
function showLogin(){
    authMode = "login";
    authTitle.innerText = "Login";
    authBox.style.display = "block";
}

/* Show Register */
function showRegister(){
    authMode = "register";
    authTitle.innerText = "Register";
    authBox.style.display = "block";
}

/* Submit Auth */
function submitAuth(){

    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();

    if(!email || !password){
        alert("Please enter email and password.");
        return;
    }

    if(authMode === "register"){
        auth.createUserWithEmailAndPassword(email,password)
        .then(()=>{
            alert("Registration successful!");
            clearAuthInputs();
        })
        .catch(err=>{
            alert(err.message);
        });
    } else {
        auth.signInWithEmailAndPassword(email,password)
        .then(()=>{
            alert("Login successful!");
            clearAuthInputs();
        })
        .catch(err=>{
            alert(err.message);
        });
    }
}

/* Clear Inputs */
function clearAuthInputs(){
    emailInput.value = "";
    passwordInput.value = "";
    authBox.style.display = "none";
}

/* Logout */
function logout(){
    auth.signOut();
}

/* Toggle Navigation Based On Login */
auth.onAuthStateChanged(user=>{
    currentUser = user;

    if(user){

        navArea.innerHTML = `
            <span style="color:#22c55e;">â— Online</span>
            <button onclick="logout()">Logout</button>
            ${user.email === "fintech.zubysworld@gmail.com" ?
            `<button onclick="window.location='ntuonline.html'">Admin</button>` : ""}
        `;

        // Update user online status
        db.collection("users").doc(user.uid).set({
            email:user.email,
            online:true,
            lastActive:Date.now()
        },{merge:true});

    } else {

        navArea.innerHTML = `
            <button onclick="showLogin()">Login</button>
            <button onclick="showRegister()">Register</button>
        `;
    }
});

/* Optional: Hide modal if clicked outside */
window.onclick = function(e){
    if(e.target === authBox){
        authBox.style.display = "none";
    }
};

auth.onAuthStateChanged(user=>{
currentUser=user;

if(user){

navArea.innerHTML=`
<span class="online">â— Online</span>
<button onclick="logout()">Logout</button>
${user.email==="fintech.zubysworld@gmail.com" ? 
`<button onclick="window.location='ntuonline.html'">Admin</button>`:""}
`;

db.collection("users").doc(user.uid).set({
email:user.email,
online:true
},{merge:true});

}else{
navArea.innerHTML=`
<button onclick="showLogin()">Login</button>
<button onclick="showRegister()">Register</button>
`;
}
});

function logout(){
auth.signOut();
}

//////////////// LIVE STREAM //////////////////

db.collection("live").doc("current")
.onSnapshot(doc=>{
if(doc.exists){
const d=doc.data();
liveArea.innerHTML=`
<h4>${d.title}</h4>
<iframe width="100%" height="315"
src="https://www.youtube.com/embed/${d.videoId}"
allowfullscreen></iframe>
`;
}else{
liveArea.innerHTML="Currently Offline";
}
});

//////////////// EVENTS //////////////////

db.collection("events").orderBy("created","desc")
.onSnapshot(snapshot=>{
eventArea.innerHTML="";
snapshot.forEach(doc=>{
const e=doc.data();
eventArea.innerHTML+=`
<div class="card">
<h4>${e.title}</h4>
<p>${e.description}</p>
${e.image?`<img src="${e.image}" width="100%">`:""}
${e.video?`<iframe width="100%" height="315" src="${e.video}"></iframe>`:""}
${e.audio?`<audio controls style="width:100%"><source src="${e.audio}"></audio>`:""}

<button onclick="rsvp('${doc.id}')">RSVP</button>
<div id="comments${doc.id}"></div>
<textarea id="comment${doc.id}" placeholder="Comment"></textarea>
<button onclick="commentEvent('${doc.id}')">Comment</button>
</div>
`;

db.collection("events").doc(doc.id).collection("comments")
.onSnapshot(cs=>{
let html="";
cs.forEach(c=>{
html+=`<p>ğŸ’¬ ${c.data().text}</p>`;
});
document.getElementById("comments"+doc.id).innerHTML=html;
});
});
});

function rsvp(id){
if(!currentUser) return alert("Login required");
db.collection("events").doc(id).collection("rsvp")
.doc(currentUser.uid).set({
user:currentUser.email
});
alert("RSVP confirmed");
}

function commentEvent(id){
if(!currentUser) return alert("Login required");
const text=document.getElementById("comment"+id).value;
db.collection("events").doc(id).collection("comments")
.add({text:text,user:currentUser.email});
document.getElementById("comment"+id).value="";
}

//////////////// FEED //////////////////

function postFeed(){
if(!currentUser) return alert("Login required");

db.collection("feed").add({
text:feedInput.value,
user:currentUser.email,
created:Date.now(),
likes:0
});
feedInput.value="";
}

db.collection("feed").orderBy("created","desc")
.onSnapshot(snapshot=>{
feedArea.innerHTML="";
snapshot.forEach(doc=>{
const f=doc.data();
feedArea.innerHTML+=`
<div class="card">
<p>${f.text}</p>
<small>By ${f.user}</small><br>
<button onclick="likePost('${doc.id}')">ğŸ‘</button>
<span>${f.likes||0}</span>
</div>
`;
});
});

function likePost(id){
if(!currentUser) return alert("Login required");
db.collection("feed").doc(id)
.update({likes:firebase.firestore.FieldValue.increment(1)});
}

//////////////// GLOBAL CHAT //////////////////

function sendChat(){
if(!currentUser) return alert("Login required");

db.collection("chat").add({
text:chatInput.value,
user:currentUser.email,
created:Date.now()
});
chatInput.value="";
}

db.collection("chat").orderBy("created")
.onSnapshot(snapshot=>{
chatMessages.innerHTML="";
snapshot.forEach(doc=>{
const m=doc.data();
chatMessages.innerHTML+=`<p><b>${m.user}:</b> ${m.text}</p>`;
});
});

//////////////// PRIVATE CHAT //////////////////

function sendPrivate(){
if(!currentUser) return alert("Login required");

const other=privateEmail.value;
const room=[currentUser.email,other].sort().join("_");

db.collection("privateChats").doc(room).collection("messages")
.add({
text:privateInput.value,
user:currentUser.email,
created:Date.now()
});
privateInput.value="";
}

/* ===============================
   USER PRESENCE SYSTEM
   =============================== */

const usersCollection = db.collection("users");

/* Mark User Online */
function setUserOnline(user){
    if(!user) return;

    usersCollection.doc(user.uid).set({
        email: user.email,
        online: true,
        lastSeen: null,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: true });
}

/* Mark User Offline */
function setUserOffline(user){
    if(!user) return;

    usersCollection.doc(user.uid).set({
        online: false,
        lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: true });
}

/* Auth State Listener */
auth.onAuthStateChanged(user=>{
    if(user){
        setUserOnline(user);
    }
});

/* Logout Override */
function logout(){
    const user = auth.currentUser;

    if(user){
        setUserOffline(user);
    }

    auth.signOut();
}

/* Detect Tab / Browser Close */
window.addEventListener("beforeunload", function () {
    const user = auth.currentUser;
    if(user){
        setUserOffline(user);
    }
});

/* Optional: Detect Page Visibility Change (Tab Switch) */
document.addEventListener("visibilitychange", function(){
    const user = auth.currentUser;
    if(!user) return;

    if(document.visibilityState === "hidden"){
        setUserOffline(user);
    } else {
        setUserOnline(user);
    }
});

</script>

</body>
</html>
