<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ntudioka Community</title>

<script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore-compat.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
body{
  margin:0;
  font-family:Arial;
  background:linear-gradient(135deg,#ff9800,#ff5722,#ff9800);
  background-size:400% 400%;
  animation:gradientMove 15s ease infinite;
  color:white;
}
@keyframes gradientMove{
  0%{background-position:0% 50%}
  50%{background-position:100% 50%}
  100%{background-position:0% 50%}
}
header{
  background:rgba(0,0,0,0.6);
  padding:15px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
section{
  max-width:900px;
  margin:25px auto;
  padding:15px;
}
.post{
  background:rgba(255,255,255,0.1);
  backdrop-filter:blur(12px);
  padding:15px;
  border-radius:15px;
  margin-top:15px;
}
button{
  padding:8px 15px;
  border:none;
  border-radius:20px;
  background:white;
  color:#ff5722;
  font-weight:bold;
  cursor:pointer;
  transition:.3s;
}
button:hover{ transform:scale(1.05); }
input,textarea{
  width:100%;
  padding:8px;
  margin-top:6px;
  border-radius:10px;
  border:none;
}
audio,video,iframe{
  width:100%;
  margin-top:10px;
  border-radius:10px;
}
.reactions i{
  margin-right:10px;
  cursor:pointer;
}
.liveChat{
  background:rgba(0,0,0,0.5);
  padding:10px;
  border-radius:10px;
  max-height:200px;
  overflow-y:auto;
}
</style>
</head>

<body>

<header>
<div><b><i class="fa-solid fa-bolt"></i> Ntudioka Community</b></div>
<div>
<input id="email" placeholder="Email">
<input id="password" type="password" placeholder="Password">
<button onclick="signup()">Sign Up</button>
<button onclick="login()">Login</button>
<button onclick="logout()">Logout</button>
<button onclick="checkAdmin()">Admin</button>
</div>
</header>

<!-- PODCASTS -->
<section>
<h2><i class="fa-solid fa-podcast"></i> Podcasts</h2>
<div id="podcastList"></div>
</section>

<!-- LIVE STREAM -->
<section>
<h2><i class="fa-solid fa-video"></i> Live Broadcast</h2>
<div id="liveBox"></div>
<div class="liveChat" id="liveChat"></div>
<input id="liveMsg" placeholder="Send live chat message">
<button onclick="sendLiveChat()">Send</button>
</section>

<!-- COMMUNITY FEED -->
<section>
<h2><i class="fa-solid fa-comments"></i> Community Feed</h2>
<textarea id="postInput" placeholder="Write message..."></textarea>
<button onclick="postMessage()">Post</button>
<div id="feed"></div>
</section>

<script>
const firebaseConfig={
 apiKey:"AIzaSyDA02mVmQxC_cu2QCyq4NN8LhQIWo50V5A",
 authDomain:"ntudioka-online-c29d8.firebaseapp.com",
 projectId:"ntudioka-online-c29d8"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();
const auth=firebase.auth();

function requireAuth(){
 if(!auth.currentUser){
   alert("Please login to interact");
   return false;
 }
 return true;
}

function signup(){
 auth.createUserWithEmailAndPassword(email.value,password.value)
 .then(()=>{
   alert("✅ Registration successful");
   email.value="";
   password.value="";
 })
 .catch(e=>alert(e.message));
}

function login(){
 auth.signInWithEmailAndPassword(email.value,password.value)
 .then(()=>{
   alert("✅ Login successful");
   email.value="";
   password.value="";
 })
 .catch(e=>alert(e.message));
}

function logout(){ auth.signOut(); }

function checkAdmin(){
 if(!auth.currentUser) return alert("Login first");
 db.collection("roles").doc(auth.currentUser.uid).get()
 .then(doc=>{
   if(doc.exists && doc.data().role==="admin"){
     location.href="ntuonline.html";
   }else alert("Admin only");
 });
}

//////////////// EMBED PODCASTS //////////////////
//<div id="podcastSection"></div>


db.collection("podcasts")
.orderBy("created","desc")
.onSnapshot(snapshot=>{
    podcastSection.innerHTML="";

    snapshot.forEach(doc=>{
        const p = doc.data();

        podcastSection.innerHTML += `
        <div class="podcastCard">
            <h3>${p.title}</h3>

            <audio controls style="width:100%; margin-top:10px;">
                <source src="${convertToDirectLink(p.audioUrl)}" type="audio/mpeg">
                Your browser does not support audio.
            </audio>
        </div>
        `;
    });
});

function convertToDirectLink(url){

    // Fix Google Drive links
    if(url.includes("drive.google.com")){
        const id = url.split("/d/")[1].split("/")[0];
        return `https://drive.google.com/uc?export=download&id=${id}`;
    }

    return url;
}

db.collection("podcasts").orderBy("created","desc")
.onSnapshot(s=>{
 podcastList.innerHTML="";
 s.forEach(doc=>{
   const p=doc.data();
   podcastList.innerHTML+=`
   <div class="post">
     <b>${p.title}</b>
     <audio controls src="${p.audioUrl}"></audio>
   </div>`;
 });
});

//////////////// LIVE STREAM //////////////////

db.collection("live").doc("current")
.onSnapshot(d=>{
 if(!d.exists){ liveBox.innerHTML="No live stream"; return;}
 const data=d.data();
 liveBox.innerHTML=`
 <iframe height="350"
 src="https://www.youtube.com/embed/${data.videoId}"
 allowfullscreen></iframe>`;
});

function sendLiveChat(){
 if(!requireAuth()) return;
 db.collection("liveChat").add({
   text:liveMsg.value,
   user:auth.currentUser.email,
   time:Date.now()
 });
 liveMsg.value="";
}

db.collection("liveChat").orderBy("time","asc")
.onSnapshot(s=>{
 liveChat.innerHTML="";
 s.forEach(doc=>{
   const m=doc.data();
   liveChat.innerHTML+=`<div><b>${m.user}:</b> ${m.text}</div>`;
 });
});

//////////////// FEED WITH EMBED LOGIC //////////////////

function extractYouTubeID(url){
 const reg=/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&]+)/;
 const match=url.match(reg);
 return match?match[1]:null;
}

function postMessage(){
 if(!requireAuth()) return;
 db.collection("posts").add({
   text:postInput.value,
   user:auth.currentUser.email,
   time:Date.now()
 });
 postInput.value="";
}

db.collection("posts").orderBy("time","desc")
.onSnapshot(s=>{
 feed.innerHTML="";
 s.forEach(doc=>{
   const p=doc.data();
   let media="";

   if(p.video){
     const ytID=extractYouTubeID(p.video);
     if(ytID){
       media=`<iframe height="315"
       src="https://www.youtube.com/embed/${ytID}"
       allowfullscreen></iframe>`;
     }else{
       media=`<video controls src="${p.video}"></video>`;
     }
   }

   if(p.audio){
     media+=`<audio controls src="${p.audio}"></audio>`;
   }

   if(p.image){
     media+=`<img src="${p.image}">`;
   }

   feed.innerHTML+=`
   <div class="post">
   <b>${p.user||"Admin"}</b>
   <p>${p.text||""}</p>
   ${media}
   <div class="reactions">
   <i class="fa-solid fa-heart" onclick="react('${doc.id}')"></i>
   </div>
   </div>`;
 });
});

function react(id){
 if(!requireAuth()) return;
 db.collection("posts").doc(id).update({
   likes:firebase.firestore.FieldValue.increment(1)
 });
}
</script>
</body>
</html>
