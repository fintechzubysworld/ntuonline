<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ntudioka Community</title>

<script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-storage-compat.js"></script>

<style>
body{font-family:sans-serif;background:#faf5ea;margin:0}
header{background:#ff9800;padding:15px;color:white;display:flex;justify-content:space-between}
section{max-width:900px;margin:25px auto;padding:15px}
.post{background:white;border-radius:15px;padding:15px;margin-top:15px}
button{padding:8px 15px;border:none;border-radius:15px;background:#ff9800;color:white;margin-top:8px}
input,textarea{width:100%;padding:8px;margin-top:6px;border-radius:10px;border:1px solid #ccc}
li{cursor:pointer;margin:6px 0}
audio{width:100%;margin-top:10px}
</style>
</head>

<body>

<header>
<div><b>ğŸ§ Ntudioka Community</b></div>
<div>
<input id="email" placeholder="Email">
<input id="password" type="password" placeholder="Password">
<button onclick="signup()">Sign up</button>
<button onclick="login()">Login</button>
<button onclick="logout()">Logout</button>
<button onclick="location.href='ntuonline.html'">Admin</button>
</div>
</header>

<!-- PODCAST PLAYER -->
<section>
<h2>ğŸ™ Podcasts</h2>
<audio id="audio" controls></audio>
<ul id="podcastList"></ul>
</section>

<!-- LIVE STREAM -->
<section>
<h2>ğŸ”´ Live Broadcast</h2>
<div id="liveBox"></div>
</section>

<!-- COMMUNITY FEED -->
<section>
<h2>ğŸŒ Community Feed</h2>
<textarea id="postInput" placeholder="Write message..."></textarea>
<button onclick="postMessage()">Post</button>
<div id="feed"></div>
</section>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDA02mVmQxC_cu2QCyq4NN8LhQIWo50V5A",
  authDomain: "ntudioka-online-c29d8.firebaseapp.com",
  projectId: "ntudioka-online-c29d8",
  storageBucket: "ntudioka-online-c29d8.appspot.com",
  messagingSenderId: "1015621578149",
  appId: "1:1015621578149:web:c755b458e505fd32928c4c"
};

firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();
const auth=firebase.auth();
const storage=firebase.storage();

//////////////// AUTH //////////////////

function signup(){
  const e=email.value,p=password.value;
  auth.createUserWithEmailAndPassword(e,p)
  .then(()=>db.collection("users").doc(auth.currentUser.uid).set({email:e}))
  .catch(err=>alert(err.message));
}

function login(){
  auth.signInWithEmailAndPassword(email.value,password.value)
  .catch(e=>alert(e.message));
}

function logout(){ auth.signOut(); }

//////////////// PODCAST PLAYER //////////////////

let playlist=[],current=0;
const audio=document.getElementById("audio");

db.collection("podcasts").orderBy("created","desc")
.onSnapshot(s=>{
  playlist=[];
  podcastList.innerHTML="";
  s.forEach((doc,i)=>{
    const p=doc.data();
    playlist.push(p.audioUrl);
    const li=document.createElement("li");
    li.innerText="â–¶ "+p.title;
    li.onclick=()=>{current=i;play();};
    podcastList.appendChild(li);
  });
});

function play(){ audio.src=playlist[current]; audio.play(); }
audio.onended=()=>{ if(current+1<playlist.length){current++;play();} };

//////////////// LIVE STREAM //////////////////

db.collection("live").doc("current")
.onSnapshot(d=>{
 if(d.exists){
   liveBox.innerHTML=
   `<iframe width="100%" height="350"
   src="https://www.youtube.com/embed/${d.data().videoId}"
   allowfullscreen></iframe>`;
 }
});

//////////////// COMMUNITY FEED //////////////////

function postMessage(){
 const u=auth.currentUser;
 if(!u)return alert("Login first");
 db.collection("posts").add({
   text:postInput.value,
   uid:u.uid,
   email:u.email,
   time:Date.now()
 });
 postInput.value="";
}

db.collection("posts").orderBy("time","desc")
.onSnapshot(s=>{
 feed.innerHTML="";
 s.forEach(doc=>{
  const p=doc.data();
  feed.innerHTML+=`
  <div class="post">
  <b>${p.email||"Admin"}</b>
  <p>${p.text||""}</p>
  ${p.video?`<video controls width="100%" src="${p.video}"></video>`:""}
  </div>`;
 });
});
</script>
</body>
</html>
