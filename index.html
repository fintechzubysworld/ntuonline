<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Ntudioka Community</title>

<script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore-compat.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
body{
margin:0;
font-family:Arial;
background:linear-gradient(135deg,#0f172a,#1e293b);
color:white;
}
header{
background:#0ea5e9;
padding:15px;
display:flex;
justify-content:space-between;
align-items:center;
}
.section{padding:20px;}
.card{
background:#1e293b;
padding:15px;
border-radius:15px;
margin-bottom:20px;
}
button{
padding:6px 12px;
border:none;
border-radius:20px;
background:#f97316;
color:white;
cursor:pointer;
margin-top:5px;
}
input,textarea{
width:100%;
padding:8px;
margin-top:6px;
border-radius:8px;
border:none;
}
.replyBox{margin-left:20px;margin-top:10px;}
.small{font-size:12px;color:#94a3b8;}
.onlineDot{color:#22c55e;}
</style>
</head>
<body>

<header>
<h2><i class="fa-solid fa-globe"></i> Ntudioka Community</h2>
<div id="navArea"></div>
</header>

<div class="section">

<!-- LIVE STREAM -->
<div class="card">
<h3>üî¥ Live Stream</h3>
<div id="liveArea">Loading...</div>

<textarea id="liveCommentInput" placeholder="Comment on live"></textarea>
<button onclick="commentLive()">Comment</button>
<div id="liveComments"></div>
</div>

<!-- EVENTS -->
<div class="card">
<h3>üìÖ Events</h3>
<div id="eventArea"></div>
</div>

<!-- FEED -->
<div class="card">
<h3>üì∞ Community Feed</h3>
<textarea id="feedInput" placeholder="Share something"></textarea>
<button onclick="postFeed()">Post</button>
<div id="feedArea"></div>
</div>

<!-- CHAT -->
<div class="card">
<h3>üí¨ Community Chat</h3>
<div id="chatArea"></div>
<input id="chatInput" placeholder="Type message">
<button onclick="sendChat()">Send</button>
</div>

<!-- GOODWILL -->
<div class="card">
<h3>ü§ù Goodwill Messages</h3>
<textarea id="goodwillInput"></textarea>
<button onclick="postGoodwill()">Post</button>
<div id="goodwillArea"></div>
</div>

</div>

<!-- AUTH -->
<div id="authContainer" style="display:none;padding:20px;background:#1e293b;">
<h3 id="authHeader">Login</h3>

<div id="registerFields" style="display:none;">
<input id="regName" placeholder="Full Name">
<input id="regKindred" placeholder="Kindred Name">
</div>

<input id="authEmail" placeholder="Email">
<input id="authPassword" type="password" placeholder="Password">

<button id="authSubmitBtn">Login</button>

<p>
<span id="toggleText">Don't have an account?</span>
<a href="#" onclick="toggleAuthMode(event)" style="color:#22c55e;">Clicküëà</a>
</p>
<div id="authMessage"></div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDA02mVmQxC_cu2QCyq4NN8LhQIWo50V5A",
    authDomain: "ntudioka-online-c29d8.firebaseapp.com",
    projectId: "ntudioka-online-c29d8",
    storageBucket: "ntudioka-online-c29d8.firebasestorage.app",
    messagingSenderId: "1015621578149",
    appId: "1:1015621578149:web:c755b458e505fd32928c4c",
    measurementId: "G-JPVKYQRKEB"
  };
firebase.initializeApp(firebaseConfig);

const auth=firebase.auth();
const db=firebase.firestore();
let currentUser=null;

/* ================= AUTH ================= */

let authMode="login";
const navArea=document.getElementById("navArea");
const authContainer=document.getElementById("authContainer");

function showAuth(){authContainer.style.display="block";}

function toggleAuthMode(){
authMode=authMode==="login"?"register":"login";
document.getElementById("registerFields").style.display=authMode==="register"?"block":"none";
document.getElementById("authHeader").innerText=authMode==="login"?"Login":"Register";
document.getElementById("authSubmitBtn").innerText=authMode==="login"?"Login":"Register";
document.getElementById("toggleText").innerText=
authMode==="login"?"Don't have an account?":"Already have an account?";
}

document.getElementById("authSubmitBtn").onclick=function(){
const email=authEmail.value.trim();
const password=authPassword.value.trim();

if(authMode==="register"){
const name=regName.value.trim();
const kindred=regKindred.value.trim();
if(!name||!kindred||!email||!password){alert("All fields required");return;}

auth.createUserWithEmailAndPassword(email,password)
.then(cred=>{
return db.collection("users").doc(cred.user.uid).set({
name,kindred,email,
online:true,
lastSeen:null,
createdAt:firebase.firestore.FieldValue.serverTimestamp()
});
})
.then(()=>{alert("Registered");authContainer.style.display="none";clearAuth();});
}else{
auth.signInWithEmailAndPassword(email,password)
.then(()=>{alert("Login successful");authContainer.style.display="none";clearAuth();})
.catch(e=>alert(e.message));
}
};

function clearAuth(){
authEmail.value="";
authPassword.value="";
if(regName)regName.value="";
if(regKindred)regKindred.value="";
}

function logout(){
if(currentUser){
db.collection("users").doc(currentUser.uid).update({
online:false,
lastSeen:firebase.firestore.FieldValue.serverTimestamp()
});
}
auth.signOut();
}

auth.onAuthStateChanged(user=>{
currentUser=user;
if(user){
db.collection("users").doc(user.uid).update({online:true});
navArea.innerHTML=`
<span class="onlineDot">‚óè Online</span>
<button onclick="logout()">Logout</button>
${user.email==="fintech.zubysworld@gmail.com"?
`<button onclick="window.location='ntuonline.html'">Admin</button>`:""}
`;
}else{
navArea.innerHTML=`<button onclick="showAuth()">Login / Register</button>`;
}
});

window.addEventListener("beforeunload",()=>{
if(currentUser){
db.collection("users").doc(currentUser.uid).update({
online:false,
lastSeen:firebase.firestore.FieldValue.serverTimestamp()
});
}
});

/* ================= FEED ================= */

function postFeed(){
if(!currentUser)return alert("Login required");
db.collection("users").doc(currentUser.uid).get()
.then(u=>{
return db.collection("feed").add({
text:feedInput.value,
name:u.data().name,
kindred:u.data().kindred,
created:Date.now()
});
})
.then(()=>feedInput.value="");
}

// Feed with replies (already functional, but shown for completeness)
db.collection("feed").orderBy("created","desc")
.onSnapshot(s=>{
  feedArea.innerHTML="";
  s.forEach(doc=>{
    const p=doc.data();
    feedArea.innerHTML+=`
      <div class="card">
        <strong>${p.name} (${p.kindred})</strong>
        <p>${p.text}</p>
        <div id="feedReplies${doc.id}"></div>
        <input id="replyFeed${doc.id}" placeholder="Reply">
        <button onclick="replyFeed('${doc.id}')">Reply</button>
      </div>
    `;
    loadReplies("feed",doc.id,"feedReplies");
  });
});
loadReplies("feed",doc.id,"feedReplies");
});
});

function replyFeed(id){
if(!currentUser)return;
db.collection("users").doc(currentUser.uid).get()
.then(u=>{
return db.collection("feed").doc(id)
.collection("replies").add({
text:document.getElementById("replyFeed"+id).value,
name:u.data().name,
kindred:u.data().kindred,
created:Date.now()
});
})
.then(()=>document.getElementById("replyFeed"+id).value="");
}

function loadReplies(collection,id,containerPrefix){
db.collection(collection).doc(id).collection("replies")
.orderBy("created")
.onSnapshot(s=>{
const box=document.getElementById(containerPrefix+id);
if(!box)return;
box.innerHTML="";
s.forEach(r=>{
box.innerHTML+=`
<div class="replyBox">
<strong>${r.data().name} (${r.data().kindred})</strong>
<p>${r.data().text}</p>
</div>`;
});
});
}

/* ================= CHAT ================= */

function sendChat(){
if(!currentUser)return;
db.collection("users").doc(currentUser.uid).get()
.then(u=>{
return db.collection("chat").add({
text:chatInput.value,
name:u.data().name,
kindred:u.data().kindred,
created:Date.now()
});
})
.then(()=>chatInput.value="");
}

// Chat messages with replies
db.collection("chat").orderBy("created")
.onSnapshot(s=>{
  chatArea.innerHTML="";
  s.forEach(doc=>{
    const m=doc.data();
    const chatId=doc.id;
    chatArea.innerHTML+=`
      <div class="card" style="margin-bottom:10px;">
        <strong>${m.name} (${m.kindred})</strong>: ${m.text}
        <div id="chatReplies${chatId}"></div>
        <input id="chatReplyInput${chatId}" placeholder="Reply to this message">
        <button onclick="replyChat('${chatId}')">Reply</button>
      </div>
    `;
    loadChatReplies(chatId);
  });
});

function replyChat(chatId){
  if(!currentUser) return alert("Login required");
  const input = document.getElementById("chatReplyInput"+chatId);
  if(!input.value.trim()) return;
  db.collection("users").doc(currentUser.uid).get()
    .then(u=>{
      return db.collection("chat").doc(chatId)
        .collection("replies").add({
          text: input.value,
          name: u.data().name,
          kindred: u.data().kindred,
          created: Date.now()
        });
    })
    .then(()=>{ input.value=""; });
}

function loadChatReplies(chatId){
  db.collection("chat").doc(chatId)
    .collection("replies")
    .orderBy("created")
    .onSnapshot(s=>{
      const container = document.getElementById("chatReplies"+chatId);
      if(!container) return;
      container.innerHTML="";
      s.forEach(doc=>{
        const r=doc.data();
        container.innerHTML+=`
          <div class="replyBox">
            <strong>${r.name} (${r.kindred})</strong>: ${r.text}
          </div>
        `;
      });
    });
}

/* ================= GOODWILL ================= */

function postGoodwill(){
if(!currentUser)return;
db.collection("users").doc(currentUser.uid).get()
.then(u=>{
return db.collection("goodwill").add({
text:goodwillInput.value,
name:u.data().name,
kindred:u.data().kindred,
created:Date.now()
});
})
.then(()=>goodwillInput.value="");
}

// Goodwill messages with replies
db.collection("goodwill").orderBy("created","desc")
.onSnapshot(s=>{
  goodwillArea.innerHTML="";
  s.forEach(doc=>{
    const g=doc.data();
    const goodwillId=doc.id;
    goodwillArea.innerHTML+=`
      <div class="card" style="margin-bottom:10px;">
        <strong>${g.name} (${g.kindred})</strong>
        <p>${g.text}</p>
        <div id="goodwillReplies${goodwillId}"></div>
        <input id="goodwillReplyInput${goodwillId}" placeholder="Reply to this message">
        <button onclick="replyGoodwill('${goodwillId}')">Reply</button>
      </div>
    `;
    loadGoodwillReplies(goodwillId);
  });
});

function replyGoodwill(goodwillId){
  if(!currentUser) return alert("Login required");
  const input = document.getElementById("goodwillReplyInput"+goodwillId);
  if(!input.value.trim()) return;
  db.collection("users").doc(currentUser.uid).get()
    .then(u=>{
      return db.collection("goodwill").doc(goodwillId)
        .collection("replies").add({
          text: input.value,
          name: u.data().name,
          kindred: u.data().kindred,
          created: Date.now()
        });
    })
    .then(()=>{ input.value=""; });
}

function loadGoodwillReplies(goodwillId){
  db.collection("goodwill").doc(goodwillId)
    .collection("replies")
    .orderBy("created")
    .onSnapshot(s=>{
      const container = document.getElementById("goodwillReplies"+goodwillId);
      if(!container) return;
      container.innerHTML="";
      s.forEach(doc=>{
        const r=doc.data();
        container.innerHTML+=`
          <div class="replyBox">
            <strong>${r.name} (${r.kindred})</strong>: ${r.text}
          </div>
        `;
      });
    });
}

/* ================= LIVE ================= */

db.collection("live").doc("current")
.onSnapshot(doc=>{
if(doc.exists){
const d=doc.data();
liveArea.innerHTML=`
<h4>${d.title}</h4>
<iframe width="100%" height="315"
src="https://www.youtube.com/embed/${d.videoId}"
allowfullscreen></iframe>
`;
}else{
liveArea.innerHTML="Currently Offline";
}
});

function commentLive(){
if(!currentUser)return;
db.collection("users").doc(currentUser.uid).get()
.then(u=>{
return db.collection("live").doc("current")
.collection("comments").add({
text:liveCommentInput.value,
name:u.data().name,
kindred:u.data().kindred,
created:Date.now()
});
})
.then(()=>liveCommentInput.value="");
}

// Live comments with replies
db.collection("live").doc("current")
.collection("comments")
.orderBy("created")
.onSnapshot(s=>{
  liveComments.innerHTML="";
  s.forEach(doc=>{
    const c=doc.data();
    const commentId=doc.id;
    liveComments.innerHTML+=`
      <div class="card" style="margin-bottom:10px;">
        <strong>${c.name} (${c.kindred})</strong>: ${c.text}
        <div id="liveReplies${commentId}"></div>
        <input id="liveReplyInput${commentId}" placeholder="Reply to this comment">
        <button onclick="replyLiveComment('${commentId}')">Reply</button>
      </div>
    `;
    loadLiveReplies(commentId);
  });
});

function replyLiveComment(commentId){
  if(!currentUser) return alert("Login required");
  const input = document.getElementById("liveReplyInput"+commentId);
  if(!input.value.trim()) return;
  db.collection("users").doc(currentUser.uid).get()
    .then(u=>{
      return db.collection("live").doc("current")
        .collection("comments").doc(commentId)
        .collection("replies").add({
          text: input.value,
          name: u.data().name,
          kindred: u.data().kindred,
          created: Date.now()
        });
    })
    .then(()=>{ input.value=""; });
}

function loadLiveReplies(commentId){
  db.collection("live").doc("current")
    .collection("comments").doc(commentId)
    .collection("replies")
    .orderBy("created")
    .onSnapshot(s=>{
      const container = document.getElementById("liveReplies"+commentId);
      if(!container) return;
      container.innerHTML="";
      s.forEach(doc=>{
        const r=doc.data();
        container.innerHTML+=`
          <div class="replyBox">
            <strong>${r.name} (${r.kindred})</strong>: ${r.text}
          </div>
        `;
      });
    });
}
</script>

</body>
</html>
